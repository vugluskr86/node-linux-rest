/*!
 * backbone.d3 0.0.1
 *
 * Copyright (c) 2013 AdRoll
 * MIT license
 * https://github.com/AdRoll/backbone.d3
 */
(function(){"use strict";var a=this,b=a._,c=a.Backbone,d=a.d3,e=a.D3=c.D3={};e.VERSION="0.0.1",e.format={_siFormat:d.format("s"),shortNumber:function(a,c){if(0===a)return"0";if(b.isNaN(a))return"NaN";var d=b.extend({sigFigs:3},c),f=0>a,g=Math.abs(a),h=Math.pow(10,d.sigFigs-Math.floor(Math.log(g)/Math.LN10)-1),i=Math.round(g*h)/h;return(f?"-":"")+e.format._siFormat(i)},longNumber:d.format(",")},e.chartDefaults={joinAttr:null,xAttr:"x",xFormat:e.format.shortNumber,xValid:b.isFinite,xScale:"linear",yAttr:"y",yFormat:e.format.shortNumber,yValid:b.isFinite,yScale:"linear",margin:{top:10,right:10,bottom:30,left:45}},e.Chart=c.View.extend({className:"bbd3",initialize:function(){b.bindAll(this,"joinData"),b.defaults(this.options,b.result(this,"defaults"),e.chartDefaults),c.View.prototype.initialize.apply(this,arguments)},render:function(){this.$el.empty();var a=this.options.margin,b=this.options.width||this.$el.width(),e=this.options.height||this.$el.height();return this.width=b-a.left-a.right,this.height=e-a.top-a.bottom,this.svg=d.select(this.el).append("svg").attr("width",b).attr("height",e).append("g").attr("transform","translate("+a.left+","+a.top+")"),this.collection instanceof c.Collection&&(this.scales={x:this.getXScale(),y:this.getYScale()},this.renderAxes(),this.renderData()),this},joinData:function(a,d){var e=this.options.joinAttr;return e&&a instanceof c.Model?a.get(e):e&&b(a).has(e)?a[e]:d},getLinearExtent:function(a,c){return c?b[c](this.collection.pluck(a)):[this.getLinearExtent(a,"min"),this.getLinearExtent(a,"max")]},getX:function(a){return this._getDatumValue(a,this.options.xAttr)},getY:function(a){return this._getDatumValue(a,this.options.yAttr)},_getDatumValue:function(a,b){return a instanceof c.Model?a.get(b):a?a[b]:null},getXScale:function(){},getYScale:function(){},renderAxes:function(){},renderData:function(){}}),e.Bar=e.Chart.extend({className:e.Chart.prototype.className+" bbd3-bar",defaults:{xFormat:b.identity,xValid:Boolean,barPadding:.2},renderAxes:function(){var a=d.svg.axis().scale(this.scales.x).orient("bottom").tickFormat(this.options.xFormat);this.svg.append("g").attr("class","x axis").attr("transform","translate(0,"+this.height+")").call(a);var b=d.svg.axis().scale(this.scales.y).orient("left").ticks(Math.ceil(this.height/40)).tickSize(-this.width).tickFormat(this.options.yFormat).tickPadding(6);this.svg.append("g").attr("class","y axis").call(b)},renderData:function(){var a=this,b=this.scales.x,c=this.scales.y;this.svg.selectAll(".bar").data(this.collection.models,this.joinData).enter().append("rect").attr("class","bar").attr("width",b.rangeBand()).attr("height",function(b){return a.height-c(a.getY(b))}).attr("transform",function(d){return"translate("+b(a.getX(d))+","+c(a.getY(d))+")"})},getXScale:function(){return d.scale.ordinal().rangeRoundBands([0,this.width],this.options.barPadding).domain(this.collection.pluck(this.options.xAttr))},getYScale:function(){return d.scale[this.options.yScale]().rangeRound([this.height,0]).domain([0,this.getLinearExtent(this.options.yAttr,"max")]).nice()}}),e.Line=e.Chart.extend({className:e.Chart.prototype.className+" bbd3-line",defaults:{valuesAttr:"values",colorAttr:"color",interpolate:"monotone",colorScale:d.scale.category10()},renderAxes:function(){var a=d.svg.axis().scale(this.scales.x).orient("bottom").ticks(Math.ceil(this.width/150)).tickFormat(this.options.xFormat).tickPadding(5);this.svg.append("g").attr("class","x axis").attr("transform","translate(0,"+this.height+")").call(a);var b=d.svg.axis().scale(this.scales.y).orient("left").ticks(Math.ceil(this.height/40)).tickFormat(this.options.yFormat).tickSize(-this.width).tickPadding(10);this.svg.append("g").attr("class","y axis").call(b)},renderData:function(){var a=this.scales.x,b=this.scales.y,c=this.options,e=d.svg.line().interpolate(c.interpolate).defined(function(a){return a&&c.yValid(a[c.yAttr])}).x(function(b){return a(b[c.xAttr])}).y(function(a){return b(a[c.yAttr])}),f=this.svg.selectAll(".series").data(this.collection.models,this.joinData).enter().append("g").attr("class","series");f.append("path").attr("class","line").attr("d",function(a){return e(a.get(c.valuesAttr))}).style("stroke",function(a,b){return a.get(c.colorAttr)||c.colorScale(b)})},getXScale:function(){return d.scale[this.options.xScale]().rangeRound([0,this.width]).domain(this.getLinearExtent(this.options.xAttr))},getYScale:function(){return d.scale[this.options.yScale]().rangeRound([this.height,0]).domain([0,this.getLinearExtent(this.options.yAttr,"max")]).nice()},getLinearExtent:function(a,c){if(!c)return e.Chart.prototype.getLinearExtent.apply(this,arguments);var d=this.collection.map(function(d){var e=d.get(this.options.valuesAttr);return b[c](e,function(b){return b&&b[a]})[a]},this);return b[c](d)}}),e.TimeSeries=e.Line.extend({className:e.Line.prototype.className+" bbd3-timeseries",defaults:b.defaults({xFormat:d.time.scale.utc().tickFormat(),xValid:b.isDate},e.Line.prototype.defaults),getXScale:function(){return d.time.scale.utc().range([0,this.width]).domain(this.getLinearExtent(this.options.xAttr))}}),e.CountryMap=e.Chart.extend({className:e.Chart.prototype.className+" bbd3-countrymap",defaults:{xValid:b.isString,yFormat:e.format.longNumber,colorRange:[d.interpolate("white","steelblue")(.2),"steelblue"],strokeWidth:2,projection:"mercator",autoZoom:!0,zoomFactor:.9,crop:[[-180,83.7],[180,-56.6]],countryData:null},initialize:function(){b.bindAll(this,"getMapTransform","getCountryFill","getCountryClass"),e.Chart.prototype.initialize.apply(this,arguments)},renderData:function(){var a=this.options.countryData;b.isString(a)?$.getJSON(a,this.renderCountries):b.isObject(a)&&this.renderCountries(a)},setCountryData:function(a){this.options.countryData=a,this.render()},renderCountries:function(a){var b=this,c=this.scales.x,d=(this.scales.y,this.options);d.countryData=a,this.svg.append("g").attr("transform",this.getMapTransform).selectAll("path").data(d.countryData.features).enter().append("path").attr("class",this.getCountryClass).attr("d",c).attr("data-code",function(a){return a.properties&&a.properties.code}).each(function(a){b.addCountryTooltip(this,a)}).style("fill",this.getCountryFill).style("stroke-width",this.getStrokeWidth(d.strokeWidth))},getXScale:function(){var a=d.geo[this.options.projection]().scale(Math.min(this.width,this.height)).translate([this.width/2,this.height/2]);return d.geo.path().projection(a)},getYScale:function(){var a=this.getLinearExtent("y");return d.scale[this.options.yScale]().range(this.options.colorRange).domain(1==this.collection.length?[0,a[1]]:a)},getCountryClass:function(a){var b=["country"],c=this.collection.findWhere({x:a.properties&&a.properties.code});return c&&this.options.yValid(this.getY(c))&&b.push("country-data"),b.join(" ")},getCountryFill:function(a){if(!a.properties)return null;var b=this.collection.findWhere({x:a.properties.code});return b?this.scales.y(this.getY(b)):null},getCountryTitle:function(a){if(!a.properties)return"";var b=this.collection.findWhere({x:a.properties.code}),c=a.properties.name;return b&&this.options.yValid(this.getY(b))&&(c+=": "+this.options.yFormat(this.getY(b))),c},addCountryTooltip:function(a,b){if(b.properties){var c=this.getDataBounds(this.collection),e=this.scales.x.bounds(b);$.fn.tooltip?$(a).tooltip({container:this.el,placement:function(){return e[1][1]>c[1][1]?"top":e[0][1]<c[0][1]?"bottom":e[1][0]>c[1][0]?"left":e[0][0]<c[0][0]?"right":"top"},title:this.getCountryTitle(b)}):d.select(a).append("title").text(this.getCountryTitle(b))}},getMapTransform:function(){var a=this.getDataBounds(this.options.autoZoom?this.collection:null),b=this.scales.x.projection().translate(),c=this.getMapScale(),d=[-(a[1][0]+a[0][0])/2,-(a[1][1]+a[0][1])/2];return"translate("+b[0]+","+b[1]+") scale("+c+") translate("+d[0]+","+d[1]+")"},getMapScale:function(){var a=this.options.zoomFactor,b=this.getDataBounds(this.options.autoZoom?this.collection:null),c=this.width,d=this.height;return a/Math.max((b[1][0]-b[0][0])/c,(b[1][1]-b[0][1])/d)},getStrokeWidth:function(a){return a||(a=1),a/Math.sqrt(this.getMapScale())},getDataBounds:function(a){var d=[[1/0,1/0],[-1/0,-1/0]],e=this.options;a instanceof c.Collection&&(a=a.models),b(a).each(function(a){var c=b(e.countryData.features).find(function(b){return b.properties.code==this.getX(a)},this);if(c){var f=this.scales.x.bounds(c);d[1][1]<f[1][1]&&(d[1][1]=f[1][1]),d[0][1]>f[0][1]&&(d[0][1]=f[0][1]),d[1][0]<f[1][0]&&(d[1][0]=f[1][0]),d[0][0]>f[0][0]&&(d[0][0]=f[0][0])}},this);var f=this.scales.x.projection(),g=[f(e.crop[0]),f(e.crop[1])];return b.isFinite(d[1][1])||(d[1][1]=g[1][1]),b.isFinite(d[0][1])||(d[0][1]=g[0][1]),b.isFinite(d[1][0])||(d[1][0]=g[1][0]),b.isFinite(d[0][0])||(d[0][0]=g[0][0]),d}})}).call(this);